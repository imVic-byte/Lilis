{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Lilis{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png">
</head>

<body class="bg-light">
    {% include 'main/navbar.html' %}
    <main class="container py-5">
        {% block content %}
        {% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    {% block scripts %}

    {{ block.super }}
    <script>
        //Botón de eliminar con SweetAlert2
        document.addEventListener('DOMContentLoaded', function () {
            const deleteButtons = document.querySelectorAll('.btn-delete');

            deleteButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();

                    const url = event.currentTarget.dataset.url;
                    const itemName = event.currentTarget.dataset.itemName || 'este elemento';

                    Swal.fire({
                        title: `¿Eliminar ${itemName}?`,
                        text: "Esta acción no se puede deshacer.",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: "Sí, eliminar",
                        cancelButtonText: "Cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = url;
                        }
                    });
                });
            });
        });
    </script>

    <script>
    // Botón para alternar vista de tarjetas/tabla y guardar preferencia en localStorage 
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('toggle-view-btn');
        const cardsView = document.getElementById('user-cards-view');
        const tableView = document.getElementById('user-table-view');
        
        // ---- 1. LEER LA VISTA GUARDADA (Al cargar la página) ----
        // Esto lee el estado y muestra la vista correcta al cargar
        const savedView = localStorage.getItem('userView') || 'cards'; // 'cards' es el default

        if (savedView === 'table') {
            // Si estaba en "tabla", la mostramos
            cardsView.style.display = 'none';
            tableView.style.display = 'block';
            toggleBtn.textContent = 'Ver Tarjetas';
        } else {
            // Por defecto (o si guardó 'cards'), mostramos tarjetas
            cardsView.style.display = 'block';
            tableView.style.display = 'none';
            toggleBtn.textContent = 'Ver Tabla';
        }


        // ---- 2. GUARDAR Y RECARGAR (Al hacer clic) ----
        toggleBtn.addEventListener('click', function() {
            // Primero, leemos la preferencia actual
            const currentView = localStorage.getItem('userView') || 'cards';
            
            // Segundo, guardamos la preferencia OPUESTA
            if (currentView === 'cards') {
                localStorage.setItem('userView', 'table');
            } else {
                localStorage.setItem('userView', 'cards');
            }
            
            // Tercero, forzamos la recarga de la página
            location.reload();
        });
    });
    </script>

    <script>
    // Botón de exportar a CSV con SweetAlert2        
        document.addEventListener('DOMContentLoaded', function () {
            const exportButtons = document.querySelectorAll('.export-btn');

            exportButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();

                    const tableId = event.currentTarget.dataset.target;
                    const filename = event.currentTarget.dataset.filename || 'exported_data';
                    const tableElement = document.getElementById(tableId);
                    const titleElement = document.querySelector('.page-title');
                    const cuteFilename = titleElement.innerText;
                    const downloadFilename = titleElement ? titleElement.innerText.trim().replace(/\s+/g, '_') : filename;
                    
                    Swal.fire({
                        title: `¿Seguro desea exportar ${cuteFilename}?`,
                        icon: "info",
                        showCancelButton: true,
                        confirmButtonColor: '#28a745',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: "Sí, exportar",
                        cancelButtonText: "Cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            if (!tableElement) {
                                console.error(`Tabla con ID '${tableId}' no encontrada.`);
                                return;
                            }

                            const wasHidden = tableElement.style.display === 'none';
                            if (wasHidden) {
                                tableElement.style.display = 'block';
                            }

                            let csvContent = [];
                            let bom = "\uFEFF";
                            const rows = tableElement.querySelectorAll("table tr");

                            rows.forEach(function (row) {
                                let rowData = [];
                                const cols = row.querySelectorAll("th, td");

                                let colLength = cols.length;

                                const lastHeader = tableElement.querySelector("thead th:last-child");
                                if (lastHeader && lastHeader.innerText.trim().toLowerCase() === 'acciones') {
                                    colLength -= 1;
                                }

                                for (let i = 0; i < colLength; i++) {
                                    let cellText = cols[i].innerText.trim().replace(/\s+/g, ' ').replace(/;/g, ',');

                                    if (cellText.includes(',')) {
                                        cellText = '"' + cellText + '"';
                                    }
                                    rowData.push(cellText);
                                }
                                csvContent.push(rowData.join(";"));
                            });

                            if (wasHidden) {
                                tableElement.style.display = 'none';
                            }

                            let csvString = bom + csvContent.join("\r\n");
                            let encodedUri = 'data:text/csv;charset=utf-8,' + encodeURI(csvString);
                            let link = document.createElement("a");
                            link.setAttribute("href", encodedUri);
                            link.setAttribute("download", `${downloadFilename}.csv`);
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    });
                });
            });
        });
    </script>

    {% endblock %}

</body>

</html>