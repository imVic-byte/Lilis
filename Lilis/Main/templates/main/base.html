{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Lilis{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="icon" href="{% static 'img/favicon.png' %}" type="image/png">
</head>

<body class="bg-light">
    {% include 'main/navbar.html' %}
    <main class="container pt-5">
        {% block content %}
        {% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    {% block scripts %}

    {{ block.super }}
    <script>
        //Botón de guardar con SweetAlert2
        const saveConfirmButtons = document.querySelectorAll('.btn-guardar-confirmar');
        const ADMIN_OVERRIDE_CODE = "Admin123";

        saveConfirmButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                
                const form = event.currentTarget.closest('form');
                if (!form) {
                    return;
                }

                event.preventDefault();

                const title = event.currentTarget.dataset.title || '¿Guardar los cambios?';
                const text = event.currentTarget.dataset.text || 'Esta acción enviará el formulario.';

                const stockInput = form.querySelector('[name="quantity"], [name="current_quantity"]');
                let stockValue = null;

                if (stockInput) {
                    let rawValue = stockInput.value;
                    
                    if (rawValue) { 
                        stockValue = parseFloat(rawValue.replace(',', '.'));
                    } else {
                        stockValue = 0;
                    }
                }

                if (stockValue !== null && !isNaN(stockValue) && stockValue < 0) {
                    Swal.fire({
                        title: 'Stock Negativo Detectado',
                        text: 'Estás a punto de registrar un stock negativo (' + stockValue + '). Por favor, ingresa el código de administrador para autorizar esta acción.',
                        icon: 'warning',
                        input: 'password',
                        inputPlaceholder: 'Ingresa el código de administrador',
                        inputAttributes: {
                            autocapitalize: 'off',
                            autocorrect: 'off'
                        },
                        showCancelButton: true,
                        confirmButtonText: 'Autorizar y Guardar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#6c757d',
                        showLoaderOnConfirm: true,
                        preConfirm: (code) => {
                            if (code === ADMIN_OVERRIDE_CODE) {
                                return true;
                            } else {
                                Swal.showValidationMessage('Código incorrecto');
                                return false;
                            }
                        },
                        allowOutsideClick: () => !Swal.isLoading()
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire({
                                title: 'Autorizado',
                                text: 'Stock negativo guardado.',
                                icon: 'success',
                                showConfirmButton: false
                            });
                            setTimeout(() => form.submit(), 2000);
                        }
                    });

                } else {

                    Swal.fire({
                        title: title,
                        text: text,
                        icon: "question",
                        showCancelButton: true,
                        confirmButtonColor: '#28a745',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: "Sí, guardar",
                        cancelButtonText: "Cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                });
                }
            });
        });
    </script>

    <script>
    // Botón para alternar vista de tarjetas/tabla y guardar preferencia en localStorage 
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('toggle-view-btn');
        const cardsView = document.getElementById('user-cards-view');
        const tableView = document.getElementById('user-table-view');
        
        // ---- 1. LEER LA VISTA GUARDADA (Al cargar la página) ----
        // Esto lee el estado y muestra la vista correcta al cargar
        const savedView = localStorage.getItem('userView') || 'cards'; // 'cards' es el default

        if (savedView === 'table') {
            // Si estaba en "tabla", la mostramos
            cardsView.style.display = 'none';
            tableView.style.display = 'block';
            toggleBtn.textContent = 'Ver Tarjetas';
        } else {
            // Por defecto (o si guardó 'cards'), mostramos tarjetas
            cardsView.style.display = 'block';
            tableView.style.display = 'none';
            toggleBtn.textContent = 'Ver Tabla';
        }


        // ---- 2. GUARDAR Y RECARGAR (Al hacer clic) ----
        toggleBtn.addEventListener('click', function() {
            // Primero, leemos la preferencia actual
            const currentView = localStorage.getItem('userView') || 'cards';
            
            // Segundo, guardamos la preferencia OPUESTA
            if (currentView === 'cards') {
                localStorage.setItem('userView', 'table');
            } else {
                localStorage.setItem('userView', 'cards');
            }
            
            // Tercero, forzamos la recarga de la página
            location.reload();
        });
    });
    </script>
        
    <script>
        //Botón de eliminar con SweetAlert2
        document.addEventListener('DOMContentLoaded', function () {
            const deleteButtons = document.querySelectorAll('.btn-delete');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const url = event.currentTarget.dataset.url;
                    const itemName = event.currentTarget.dataset.itemName || 'este elemento';
                    Swal.fire({
                        title: `¿Eliminar ${itemName}?`,
                        text: "Esta acción no se puede deshacer.",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: "Sí, eliminar",
                        cancelButtonText: "Cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = url;
                        }
                    });
                });
            });
        });
    </script>
    {% endblock %}
</body>
</html>