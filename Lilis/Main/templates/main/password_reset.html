{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Recuperación de contraseña</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    :root{--accent:#2563eb;--bg:#f7f9fc;--card:#ffffff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;align-items:center;justify-content:center;min-height:100vh;margin:0;background:linear-gradient(180deg,var(--bg),#eef4ff)}
    .container{width:100%;max-width:420px;padding:24px}
    .card{background:var(--card);border-radius:12px;padding:24px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
    h1{font-size:1.25rem;margin:0 0 6px}
    p.lead{margin:0 0 18px;color:var(--muted);font-size:0.95rem}
    label{display:block;font-size:0.85rem;margin-bottom:6px}
    .field{margin-bottom:14px}
    input[type=text],input[type=email],input[type=password]{width:100%;padding:10px 12px;border:1px solid #e6e9ef;border-radius:8px;font-size:0.95rem}
    .row{display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#eef2ff;color:var(--accent);border:1px solid rgba(37,99,235,0.12)}
    .muted{color:var(--muted);font-size:0.9rem}
    .helper{font-size:0.85rem;color:#9ca3af;margin-top:6px}
    .strength{height:8px;border-radius:6px;background:#eef2f7;overflow:hidden}
    .strength > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#f97316,#84cc16)}
    .actions{display:flex;gap:8px;margin-top:8px}
    .msg{padding:10px;border-radius:8px;background:#f1f5f9;color:#0f172a;font-size:0.95rem}
    .small{font-size:0.85rem}
    .toggle{background:none;border:0;color:var(--accent);cursor:pointer;font-weight:600}
    @media (max-width:420px){.container{padding:16px}.card{padding:18px}}  
  </style>
</head>

<body>
    {% include 'main/navbar.html' %}
    <main class="container" aria-labelledby="title">
        <section class="card" role="region" aria-label="Formulario de recuperación de contraseña">
            <h1 id="title">Recuperar contraseña</h1>
            <p class="lead">Introduce tu correo para recibir un enlace de recuperación, o pega el token que recibiste y
                define una nueva contraseña.</p>

            <!-- Paso 1: pedir email -->
            <form id="recovery-form" autocomplete="off">
                <div class="field">
                    <label for="email">Correo electrónico</label>
                    <input id="email" name="email" type="email" inputmode="email" placeholder="tú@ejemplo.com" required
                        aria-describedby="email-help" />
                    <div id="email-help" class="helper">Te enviaremos un enlace o un código temporal para restablecer la
                        contraseña.</div>
                </div>

                <div class="field">
                    <label for="token">Token (opcional)</label>
                    <input id="token" name="token" type="text" placeholder="Código recibido por correo"
                        aria-describedby="token-help" />
                    <div id="token-help" class="helper">Si pegaste un token, podrás cambiar la contraseña directamente.
                    </div>
                </div>

                <hr aria-hidden="true" style="border:none;border-top:1px solid #eef2f7;margin:12px 0 14px" />

                <!-- Paso 2: nueva contraseña -->
                <div class="field">
                    <label for="password">Nueva contraseña</label>
                    <div class="row">
                        <input id="password" name="password" type="password" placeholder="Mínimo 8 caracteres"
                            aria-describedby="pw-help" required />
                        <button class="toggle" type="button" id="toggle-pw"
                            aria-label="Mostrar contraseña">Mostrar</button>
                    </div>
                    <div id="pw-help" class="helper">Usa al menos 8 caracteres, incluye letras y números para mayor
                        seguridad.</div>
                    <div class="strength" aria-hidden="true" style="margin-top:8px"><i id="strength-bar"></i></div>
                </div>

                <div class="field">
                    <label for="confirm">Confirmar contraseña</label>
                    <input id="confirm" name="confirm" type="password" placeholder="Repite la nueva contraseña"
                        required />
                </div>

                <div class="actions">
                    <a href='{% url "login" %}'class="btn">Restablecer contraseña</a>
                    <button type="button" class="btn secondary" id="send-link">Enviar enlace</button>
                </div>

                <p class="muted small" style="margin-top:12px">Recibirás un correo con instrucciones, si no lo ves
                    revisa la carpeta de spam.</p>

                <div id="response" style="margin-top:12px;display:none" role="status" aria-live="polite"></div>
            </form>

        </section>
    </main>

    <script>
        // Referencias
        const form = document.getElementById('recovery-form');
        const email = document.getElementById('email');
        const token = document.getElementById('token');
        const pw = document.getElementById('password');
        const confirm = document.getElementById('confirm');
        const resp = document.getElementById('response');
        const sendLinkBtn = document.getElementById('send-link');
        const togglePw = document.getElementById('toggle-pw');
        const strengthBar = document.getElementById('strength-bar');

        // Mostrar / ocultar contraseña
        togglePw.addEventListener('click', () => {
            const t = pw.type === 'password' ? 'text' : 'password';
            pw.type = t; confirm.type = t;
            togglePw.textContent = t === 'text' ? 'Ocultar' : 'Mostrar';
        });

        // Indicador de fuerza simple
        function evaluateStrength(value) {
            let score = 0;
            if (value.length >= 8) score += 1;
            if (/[A-Z]/.test(value)) score += 1;
            if (/[0-9]/.test(value)) score += 1;
            if (/[^A-Za-z0-9]/.test(value)) score += 1;
            return score; // 0..4
        }

        pw.addEventListener('input', () => {
            const s = evaluateStrength(pw.value);
            const percent = (s / 4) * 100;
            strengthBar.style.width = percent + '%';
        });

        // Enviar enlace (simulado)
        sendLinkBtn.addEventListener('click', async () => {
            if (!email.checkValidity()) {
                email.reportValidity();
                return;
            }
            resp.style.display = 'block';
            resp.className = 'msg';
            resp.textContent = 'Enviando enlace...';

            // Aquí pondrías una llamada al backend, ej.:
            // await fetch('/api/auth/send-reset', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email: email.value})})

            setTimeout(() => {
                resp.textContent = 'Enlace enviado a ' + email.value + ', revisa tu correo.';
            }, 700);
        });

        // Envío del formulario para restablecer contraseña
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Validaciones básicas
            if (!email.checkValidity()) return email.reportValidity();
            if (pw.value.length < 8) {
                resp.style.display = 'block'; resp.className = 'msg'; resp.textContent = 'La contraseña debe tener al menos 8 caracteres.'; return;
            }
            if (pw.value !== confirm.value) {
                resp.style.display = 'block'; resp.className = 'msg'; resp.textContent = 'Las contraseñas no coinciden.'; return;
            }

            resp.style.display = 'block'; resp.className = 'msg'; resp.textContent = 'Procesando...';

            // Simulación de petición al servidor
            // Datos que enviarías: {email: email.value, token: token.value, password: pw.value}
            try {
                // const r = await fetch('/api/auth/reset', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email.value,token:token.value,password:pw.value})});
                // const data = await r.json();
                setTimeout(() => {
                    resp.textContent = 'Contraseña restablecida correctamente. Puedes iniciar sesión con tu nueva contraseña.';
                    form.reset();
                    strengthBar.style.width = '0%';
                }, 900);
            } catch (err) {
                resp.textContent = 'Ocurrió un error, intenta nuevamente más tarde.';
            }
        });

        // Nota de seguridad: en producción, valida todo en el servidor, usa TLS, y tokens con expiración
    </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>