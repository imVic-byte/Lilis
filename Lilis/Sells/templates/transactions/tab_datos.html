<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Fecha</label>
        <input type="datetime-local" class="form-control" name="fecha" id="fecha" disabled>
    </div>
    <div class="col-md-4">
        <label class="form-label">Tipo</label>
        <select class="form-select" name="tipo" id="tipo">
            <option>Seleccione...</option>
            <option value="ingreso">Ingreso</option>
            <option value="salida">Salida</option>
            <option value="ajuste">Ajuste</option>
            <option value="devolucion">Devolucion</option>
            <option value="transferencia">Transferencia</option>
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Cantidad</label>
        <input type="number" class="form-control" name="cantidad" id="cantidad" disabled placeholder="Seleccione un producto">
        <input type="number" class="d-none" name="stock" id="stock" disabled>
    </div>
</div>
<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Producto</label>
        <select class="form-select" name="producto" id="product-select">
            <option value="">Seleccione un tipo de movimiento</option>
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Cliente/Proveedor</label>
        <select class="form-select" name="client" id="client-select">
            <option value="">Seleccione...</option>
            {% for c in clients %}
                <option value="{{ c.id }}" >{{ c.bussiness_name }} / {{ c.fantasy_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Bodega</label>
        <select class="form-select" name="warehouse" id="warehouse-select">
            <option value="">Seleccione un cliente primero</option>
        </select>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const clientSelect = document.getElementById('client-select');
        const warehouseSelect = document.getElementById('warehouse-select');
        const productSelect = document.getElementById('product-select');
        const cantidadInput = document.getElementById('cantidad');
        const stockInput = document.getElementById('stock');
        const typeSelect = document.getElementById('tipo');

        typeSelect.addEventListener('change', function () {
            const type = this.value;
            if (!type) {
                clientSelect.disabled = true;
                clientSelect.value = '';
                clientSelect.placeholder = 'Seleccione un movimiento';
                return;
            }
            if (type === 'ingreso'){
                fetch(`/sells/get_by_type/?type=${type}`)
                .then(r => r.json())
                .then(data => {
                    clientSelect.disabled = false;
                    clientSelect.innerHTML = '';
                    if (data.data.length === 0) {
                    clientSelect.innerHTML = '<option value="">No hay clientes para este tipo de movimiento</option>';
                        return;
                    }
                    else {
                        warehouseSelect.innerHTML = '<option value="">Seleccione una bodega</option>';
                        data.data.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.id;
                            option.textContent = `${p.bussiness_name}`;
                            clientSelect.appendChild(option);
                            p.warehouses.forEach(warehouse => {
                                const warehouseOption = document.createElement('option');
                                warehouseOption.value = warehouse.id;
                                warehouseOption.textContent = `${warehouse.name} - ${p.bussiness_name}`;
                                warehouseSelect.appendChild(warehouseOption);
                            });
                    })
                }})
                .catch(error => console.error('Error al cargar datos:', error));
            }
            else if (type === 'salida'){
                fetch(`/sells/get_by_type/?type=${type}`)
                .then(r => r.json())
                .then(data => {
                    clientSelect.disabled = false;
                    clientSelect.innerHTML = '';
                    if (data.data.length === 0) {
                        clientSelect.innerHTML = '<option value="">No hay clientes para este tipo de movimiento</option>';
                        return;
                    }
                    data.data.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = `${p.bussiness_name}`;
                        clientSelect.appendChild(option);
                    });
                    data.data.p.forEach(warehouses => {
                        const option = document.createElement('option');
                        option.value = p.warehouses.id;
                        option.textContent = `${p.warehouses.name} - ${p.bussiness_name}`;
                        warehouseSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error al cargar datos:', error));
            }
            else if (type === 'ajuste' || type === 'devolucion' || type === 'transferencia') {
                fetch(`/sells/get_by_type/?type=${type}`)
                .then(r => r.json())
                .then(data => {
                    clientSelect.disabled = false;
                    clientSelect.innerHTML = '';
                    if (data.data.length === 0) {
                        clientSelect.innerHTML = '<option value="">No hay clientes para este tipo de movimiento</option>';
                        return;
                    }
                    data.data.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = `${p.name}`;
                        clientSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error al cargar datos:', error));
            }
        });
        

        clientSelect.addEventListener('change', function() {
        const selectedClientId = this.value;
        
        if (selectedClientId) {
            warehouseSelect.disabled = false;
            Array.from(warehouseSelect.options).forEach(option => {
                if (option.value) {
                    option.style.display = 'none';
                }
            });
            Array.from(warehouseSelect.options).forEach(option => {
                if (option.getAttribute('data-client') == selectedClientId) {
                    option.style.display = 'block';
                }
            });
            warehouseSelect.value = '';
        } else {
            warehouseSelect.disabled = true;
            warehouseSelect.value = '';
        }
    });


        productSelect.addEventListener('change', function () {
            const productId = this.value;
            if (!productId) {
                cantidadInput.disabled = true;
                cantidadInput.value = '';
                stockInput.value = '';
                cantidadInput.placeholder = 'Seleccione un producto';
                return;
            }
            fetch(`/sells/get_stock_by_product/?product_id=${productId}`)
                .then(r => r.json())
                .then(data => {
                    cantidadInput.disabled = false;
                    cantidadInput.value = data.stock;
                    stockInput.value = data.stock;
                })
                .catch(error => console.error('Error al obtener stock:', error));
        });

        clientSelect.addEventListener('change', function () {
            const clientId = this.value;
            if (!clientId) {
                warehouseSelect.innerHTML = '<option value="">Seleccione un cliente primero</option>';
                return;
            }
            fetch(`/sells/warehouses_by_client/?client_id=${clientId}`)
                .then(r => r.json())
                .then(data => {
                    warehouseSelect.innerHTML = '';
                    if (data.warehouses.length === 0) {
                        warehouseSelect.innerHTML = '<option value="">No hay bodegas para este cliente</option>';
                        return;
                    }
                    data.warehouses.forEach(wc => {
                        const option = document.createElement('option');
                        option.value = wc.id;
                        option.textContent = `${wc.name} - ${wc.address} (${wc.location})`;
                        warehouseSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error al cargar bodegas:', error));
        });
    });
</script>
<script>
            window.addEventListener('DOMContentLoaded', function () {
                const input = document.getElementById('fecha');
                if (!input) return;
                const now = new Date();
                const tzOffset = now.getTimezoneOffset() * 60000;
                const localISO = new Date(now - tzOffset).toISOString().slice(0,16);
                input.value = localISO;
            });
</script>