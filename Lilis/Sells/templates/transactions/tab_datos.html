<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Fecha</label>
        <input type="datetime-local" class="form-control" name="fecha" id="fecha" disabled>
    </div>
    <div class="col-md-4">
        <label class="form-label">Tipo</label>
        <select class="form-select" name="tipo" id="tipo">
            <option>Seleccione...</option>
            <option value="ingreso">Ingreso</option>
            <option value="salida">Salida</option>
            <option value="produccion">Producci√≥n</option>
            <option value="devolucion">Devolucion</option>
            <option value="transferencia">Transferencia</option>
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Cantidad</label>
        <input type="number" class="form-control" name="cantidad" id="cantidad" disabled placeholder="Seleccione un producto">
        <input type="number" class="d-none" name="stock" id="stock" readonly>
    </div>
</div>
<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Producto</label>
        <select class="form-select" name="producto" id="product-select">
            <option value="">Seleccione un tipo de movimiento</option>
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Cliente/Proveedor</label>
        <select class="form-select" name="client" id="client-select">
            <option value="">Seleccione...</option>
            {% for c in clients %}
                <option value="{{ c.id }}" >{{ c.bussiness_name }} / {{ c.fantasy_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Bodega</label>
        <select class="form-select" name="warehouse" id="warehouse-select">
            <option value="">Seleccione un cliente primero</option>
        </select>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const clientSelect = document.getElementById('client-select');
    const warehouseSelect = document.getElementById('warehouse-select');
    const productSelect = document.getElementById('product-select');
    const cantidadInput = document.getElementById('cantidad');
    const stockInput = document.getElementById('stock');
    const typeSelect = document.getElementById('tipo');

    const resetSelect = (select, placeholder = '') => {
        select.innerHTML = placeholder ? `<option value="">${placeholder}</option>` : '';
    };

    const fillSelect = (parent, list, fn) => {
        list.forEach(e => {
            const o = document.createElement('option');
            const { value, text } = fn(e);
            o.value = value;
            o.textContent = text;
            parent.appendChild(o);
        });
    };
    typeSelect.addEventListener('change', function () {
        const type = this.value;

        if (!type) return;

        fetch(`/sells/get_by_type/?type=${type}`)
            .then(r => r.json())
            .then(res => {
                const data = res.data || [];

                clientSelect.disabled = false;
                resetSelect(clientSelect);
                resetSelect(warehouseSelect);
                resetSelect(productSelect);
                if (type === 'ingreso') {
                    resetSelect(clientSelect, 'Seleccione un proveedor');
                    resetSelect(warehouseSelect, 'Seleccione una bodega');
                    resetSelect(productSelect, 'Seleccione primero un proveedor');

                    data.suppliers.forEach(s => {
                        const o = document.createElement('option');
                        o.value = s.id;
                        o.textContent = s.bussiness_name;
                        clientSelect.appendChild(o);
                    });

                    data.warehouses.forEach(w => {
                        const o = document.createElement('option');
                        o.value = w.id;
                        o.textContent = `${w.name} - ${w.location}`;
                        warehouseSelect.appendChild(o);
                    });

                    return;
                }
                if (type === 'salida') {
                    resetSelect(clientSelect, 'Seleccione un cliente');
                    resetSelect(warehouseSelect, 'Seleccione una bodega');

                    data.forEach(c => {
                        const o = document.createElement('option');
                        o.value = c.id;
                        o.textContent = c.bussiness_name;
                        clientSelect.appendChild(o);
                    });

                    return;
                }
                if (type === 'devolucion') {
                    resetSelect(clientSelect, 'Seleccione un cliente');
                    resetSelect(productSelect, 'Seleccione un producto o materia prima');
                    resetSelect(warehouseSelect, 'Seleccione una bodega');
                    data.clients.forEach(e => {
                        const o = document.createElement('option');
                        o.value = e.id;
                        o.textContent = e.bussiness_name;
                        clientSelect.appendChild(o);
                    });

                    const gP = document.createElement('optgroup');
                    gP.label = 'Productos';
                    fillSelect(gP, data.products, e => ({
                        value: `product-${e.id}`,
                        text: `${e.sku ?? ''} ${e.name}`.trim()
                    }));

                    const gR = document.createElement('optgroup');
                    gR.label = 'Materias primas';
                    fillSelect(gR, data.raw_materials, e => ({
                        value: `raw_material-${e.id}`,
                        text: `${e.sku ?? ''} ${e.name}`.trim()
                    }));
                    productSelect.appendChild(gP);
                    productSelect.appendChild(gR);
                    data.warehouses.forEach(e => {
                        const o = document.createElement('option');
                        o.value = e.id;
                        o.textContent = `${e.name} - ${e.address} - ${e.location}`;
                        warehouseSelect.appendChild(o);
                    });

                    return;
                }
                if (type === 'transferencia') {
                    resetSelect(clientSelect, "Seleccione a Lilis");
                    data.clients.forEach(e => {
                        const o = document.createElement('option');
                        o.value = e.id;
                        o.textContent = e.bussiness_name;
                        clientSelect.appendChild(o);
                    });

                    resetSelect(productSelect, 'Seleccione un producto o materia prima');

                    const gP = document.createElement('optgroup');
                    fillSelect(gP, data.inventory, e => ({
                        value: `product-${e.id}`,
                        text: `${e.sku ?? ''} ${e.name}`.trim()
                    }));
                    productSelect.appendChild(gP);
                    return;
                }
                if (type === 'produccion') {
                    resetSelect(clientSelect, 'Seleccione la empresa');
                    resetSelect(productSelect, 'Seleccione un producto');
                    resetSelect(warehouseSelect, 'Seleccione una bodega');

                    data.clients.forEach(e => {
                        const o = document.createElement('option');
                        o.value = e.id;
                        o.textContent = e.bussiness_name;
                        clientSelect.appendChild(o);
                    });
                    data.products.forEach(e => {
                        const o = document.createElement('option');
                        o.value = `producto-${e.id}`;
                        o.textContent = `${e.sku ?? ''} ${e.name}`.trim();
                        productSelect.appendChild(o);
                    });
                    data.warehouses.forEach(e => {
                        const o = document.createElement('option');
                        o.value = e.id;
                        o.textContent = `${e.name} - ${e.address} - ${e.location}`;
                        warehouseSelect.appendChild(o);
                    });
                    return;
                }
            })
            .catch(e => console.error("Error al cargar datos:", e));
    });
    clientSelect.addEventListener('change', function () {
        const client = this.value;
        const type = typeSelect.value;

        if (!client) {
            resetSelect(productSelect, 'Seleccione un cliente/proveedor');
            return;
        }
        if (type === 'ingreso' || type === 'salida') {
            fetch(`/sells/get_raw_materials_by_supplier/?id=${client}&type=${type}`)
                .then(r => r.json())
                .then(res => {
                    const data = res.p || [];
                    if (type === 'ingreso') {
                    resetSelect(productSelect, 'Seleccione una materia prima');

                    if (data.length === 0) {
                        productSelect.innerHTML = '<option value="">No hay productos para este proveedor</option>';
                        return;
                    }

                    fillSelect(productSelect, data, s => ({
                        value: s.id,
                        text: `${s.sku ?? ''} ${s.name}`.trim()
                    }));

                    return;
                }
                if (type === 'salida') {
                    resetSelect(productSelect, 'Seleccione un producto');

                    fillSelect(productSelect, data, c => ({
                        value: `product-${c.id}`,
                        text: `${c.sku ?? ''} ${c.name}`.trim()
                    }));
                    fetch(`/sells/warehouses_by_client/?id=${client}&type=${type}`)
                        .then(r => r.json())
                        .then(res => {
                            const ws = res.warehouses || [];
                            resetSelect(warehouseSelect, 'Seleccione una bodega');

                            ws.forEach(w => {
                                const o = document.createElement('option');
                                o.value = w.id;
                                o.textContent = `${w.name} - ${w.location}`;
                                warehouseSelect.appendChild(o);
                            });
                        });

                    return;
                }
            })
            .catch(e => console.error("Error al cargar datos:", e));
        }
    });
    
    productSelect.addEventListener('change', function () {
        const product = this.value;
        const type = typeSelect.value;

        if (!product) {
            cantidadInput.value = '';
            stockInput.value = '';
            return;
        }
        if (type === 'ingreso') {
            cantidadInput.disabled = false;
            cantidadInput.value = '';
            stockInput.value = '';
            return;
        }
        if (type === 'salida') {
            cantidadInput.disabled = false;
            fetch(`/sells/get_stock_by_product/?product_id=${product}`)
                .then(r => r.json())
                .then(res => {
                    cantidadInput.disabled = false;
                    stockInput.value = res.stock ?? 0;
                    cantidadInput.value = res.stock ?? 0;
                })
                .catch(e => console.error("Error al cargar stock:", e));
            return;
        }
        if (type === 'transferencia') {
            cantidadInput.disabled = false;
            fetch(`/sells/get_stock_by_inventory/?id=${product}`)
                .then(r => r.json())
                .then(res => {
                    cantidadInput.disabled = false;
                    stockInput.value = res.stock ?? 0;
                    cantidadInput.value = res.stock ?? 0;
                })
                .catch(e => console.error("Error al cargar stock:", e));
            fetch(`/sells/warehouses_by_inventory/?id=${product}`)
                .then(r => r.json())
                .then(res => {
                    const ws = res.warehouses || [];
                    resetSelect(warehouseSelect, 'Seleccione una bodega');

                    ws.forEach(w => {
                        const o = document.createElement('option');
                        o.value = w.id;
                        o.textContent = `${w.name} - ${w.location}`;
                        warehouseSelect.appendChild(o);
                    });
                })
                .catch(e => console.error("Error al cargar bodegas:", e));
            return;
        }
        if (type === 'devolucion') {
            cantidadInput.disabled = false;
            cantidadInput.value = '';
            stockInput.value = '';
            return;
        }
        if (type === 'produccion') {
            cantidadInput.disabled = false;
            cantidadInput.placeholder = 'Ingrese cantidad';
            cantidadInput.value = '';
            stockInput.value = '';
            return;
        }
    });
});
</script>


<script>
            window.addEventListener('DOMContentLoaded', function () {
                const input = document.getElementById('fecha');
                if (!input) return;
                const now = new Date();
                const tzOffset = now.getTimezoneOffset() * 60000;
                const localISO = new Date(now - tzOffset).toISOString().slice(0,16);
                input.value = localISO;
            });
</script>