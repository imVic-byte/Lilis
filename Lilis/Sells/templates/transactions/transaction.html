{% extends 'main/base.html' %}

{% block title %} Transacciones {% endblock title %}
{% block content %}
<div class="row mb-3">
    <div class="col-12 text-center">
        <h1 class="page-title">Transaccion de Lotes</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center p-3 shadow-sm">
            <h5 class="mb-1">Movimientos (hoy)</h5>  
            <h2 class="fw-bold"> {{ transactions_today }} </h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-center p-3 shadow-sm">
            <h5 class="mb-1">Stock total demo</h5>
            <h2 class="fw-bold">8</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-center p-3 shadow-sm">
            <h5 class="mb-1">Productos únicos</h5>
            <h2 class="fw-bold">1</h2>
        </div>
    </div>
</div>


<div class="card shadow-sm mb-4 p-4">
    <form id="transaction-form" action="#" method="POST">
        <div class="row">
            <div class="col-6">
                <h4 class="mb-3">Registrar movimiento</h4>
            </div>
            <div class="col-6">
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">Guardar movimiento</button>
                    <button type="reset" class="btn btn-secondary">Limpiar</button>
                </div>
            </div>
        </div>
        {% csrf_token %}
        <ul class="nav nav-tabs mb-3" id="registroTabs">
            <li class="nav-item">
                <a class="nav-link active text-dark" data-bs-toggle="tab" href="#tab1">1. Datos del movimiento</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-dark" data-bs-toggle="tab" href="#tab2">2. Control avanzado</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-dark" data-bs-toggle="tab" href="#tab3">3. Referencias/Observaciones</a>
            </li>
        </ul>

        <div class="tab-content">

            <div class="tab-pane fade show active" id="tab1">
                {% include 'transactions/tab_datos.html' %}
            </div>
            <div class="tab-pane fade" id="tab2">
                {% include 'transactions/tab_control.html' %}
            </div>
            <div class="tab-pane fade" id="tab3">
                {% include 'transactions/tab_refs.html' %}
            </div>
        </div>
    </form>

</div>


<div class="card shadow-sm p-4">
<div class="row mb-2 justify-content-center">
    <div class="col-md-9 mt-2">
        <form method="GET" action="{% url 'transaction_list' %}" class="form">
            <div class="input-group">
                <label class="input-group-text" for="per_page_select">Mostrar:</label>
                <select class="form-select" style="max-width: 100px;" id="per_page_select" name="per_page" onchange="this.form.submit()">
                    <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>

                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>

                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
                <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
                <input type="hidden" name="order" value="{{ current_order }}">

                <input type="text" class="form-control" name="q" value="{{ q|default:'' }}" placeholder="Buscar por SKU, tipo, RUT cliente...">
                
                <button class="btn btn-primary" type="submit">Buscar</button>
            </div>
        </div>
        <div class="col-md-3">
            <div class="col text-end">
                <a href="{% url 'export_transaction_excel' %}{% if q %}?q={{ q|urlencode }}{% endif %}" class="btn btn-success mt-2">
                    Exportar Todo
                </a>
                <a href="{% url 'export_transaction_excel' %}?limit={{ per_page }}{% if q %}&amp;q={{ q|urlencode }}{% endif %}"
                    class="btn btn-info mt-2">
                    Exportar Vista
                </a>
            </div>
        </div>
        </div>  

    <table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>SKU</th>
            <th>Proveedor</th>
            <th>Bodega</th>
            <th>Cantidad</th>
            <th>Lote</th>
            <th>Serie</th>
            <th>Vence</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
        {% for t in page_obj %}
        <tr>
            <td>{{ t.date }}</td>

            {% if t.type == 'ingreso' %}
                <td><span class="badge bg-success text-center">{{ t.type }}</span></td>
            {% else %}
                <td><span class="badge bg-danger text-center">{{ t.type }}</span></td>
            {% endif %}

            <td>{{ t.product.sku }}</td>
            <td>{{ t.client.rut }}</td>
            <td>{{ t.warehouse.name }}</td>

            {% if t.type == 'ingreso' %}
                <td class="text-success fw-bold">+ {{ t.quantity }}</td>
            {% else %}
                <td class="text-danger fw-bold">- {{ t.quantity }}</td>
            {% endif %}

            <td>{{ t.batch_code|default_if_none:"-" }}</td>
            <td>{{ t.serie_code|default_if_none:"-" }}</td>
            <td>{{ t.expiration_date|default_if_none:"-" }}</td>

            <td>
                <button class="btn btn-primary btn-sm">Editar</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="10" class="text-center">
                No se encontraron datos que coincidan con los filtros.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

</div>
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
  <ul class="pagination justify-content-center">

    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&amp;{{ querystring }}{% endif %}" aria-label="Previous">
          &laquo; Anterior
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">&laquo; Anterior</span>
      </li>
    {% endif %}

    {% for i in page_obj.paginator.page_range %}
      {% if page_obj.number == i %}
        <li class="page-item active" aria-current="page">
          <span class="page-link">{{ i }}</span>
        </li>
      {% else %}
        <li class="page-item">
          <a class="page-link" href="?page={{ i }}{% if querystring %}&amp;{{ querystring }}{% endif %}">{{ i }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&amp;{{ querystring }}{% endif %}" aria-label="Next">
          Siguiente &raquo;
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Siguiente &raquo;</span>
      </li>
    {% endif %}

  </ul>
</nav>

<div class="text-center text-muted mt-2">
  Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ total }} resultados.
</div>
{% endif %}
{% endblock content %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('transaction-form');
    const ADMIN_OVERRIDE_CODE = "Admin123";
    form.addEventListener('submit', function (e) {
        e.preventDefault();

        const getVal = id => {
            const el = document.getElementById(id);
            return el ? (el.value || '').trim() : '';
        };

        const fecha = getVal('fecha');
        const tipo = getVal('tipo');
        const cantidad = getVal('cantidad');
        const producto = getVal('product-select');
        const cliente = getVal('client-select');
        const bodega = getVal('warehouse-select');

        const loteCheckbox = document.getElementById('control-lotes');
        const serieCheckbox = document.getElementById('control-series');
        const vencimientoCheckbox = document.getElementById('control-vencimiento');
        const loteInput = document.getElementById('input-lote');
        const serieInput = document.getElementById('input-serie');
        const vencimientoInput = document.getElementById('input-vencimiento');
        const observaciones = document.getElementById('observaciones');

        let errores = [];

        if (!fecha) errores.push("Debe seleccionar una fecha.");
        if (!tipo) errores.push("Debe seleccionar un tipo de movimiento.");
        if (!cantidad) errores.push("La cantidad no debe ser 0");
        if (!producto) errores.push("Debe seleccionar un producto.");
        if (!cliente) errores.push("Debe seleccionar un cliente/proveedor.");
        if (!bodega) errores.push("Debe seleccionar una bodega.");

        if (loteCheckbox && loteCheckbox.checked && !loteInput || !loteInput.value.trim()) {
            errores.push("Debe ingresar un lote.");
        }
        if (serieCheckbox && serieCheckbox.checked && !serieInput || !serieInput.value.trim()) {
            errores.push("Debe ingresar una serie.");
        }

        if (loteCheckbox.checked) {
            if (!vencimientoCheckbox.checked || !vencimientoInput.value.trim()) {
                errores.push("Debe activar vencimiento e ingresar una fecha.");
            }else if (new Date(vencimientoInput.value) < new Date()) {
            errores.push("La fecha de vencimiento no puede ser anterior a la fecha actual.");
            }
        }

        if (loteCheckbox && !loteCheckbox.checked && serieCheckbox && !serieCheckbox.checked) {
            errores.push("Debe seleccionar un tipo de control.");
        }


        if (!observaciones || !observaciones.value.trim()) {
            errores.push("Debe ingresar observaciones.");
        } else if (observaciones.value.trim().length > 500) {
            errores.push("Las observaciones no pueden exceder los 500 caracteres.");
        }

        if (errores.length > 0) {
            Swal.fire({
                icon: 'error',
                title: 'Errores en el formulario',
                html: '<ul style="text-align:left; margin:0;">' + errores.map(err => '<li>' + err + '</li>').join('') + '</ul>',
                confirmButtonText: 'Corregir'
            });
            return;
        }

        if (cantidad !== '' && !isNaN(cantidad) && Number(cantidad) < 0) {
            Swal.fire({
                title: 'Stock Negativo Detectado',
                text: 'Estás a punto de registrar un stock negativo (' + cantidad + '). Por favor, ingresa el código de administrador para autorizar esta acción.',
                icon: 'warning',
                input: 'password',
                inputPlaceholder: 'Ingresa el código de administrador',
                inputAttributes: {
                    autocapitalize: 'off',
                    autocorrect: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'Autorizar y Guardar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                showLoaderOnConfirm: true,
                preConfirm: (code) => {
                    if (code === ADMIN_OVERRIDE_CODE) {
                        return true;
                    } else {
                        Swal.showValidationMessage('Código incorrecto');
                        return false;
                    }
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Autorizado',
                        text: 'Stock negativo guardado.',
                        icon: 'success',
                        showConfirmButton: false
                    });
                    setTimeout(() => form.submit(), 2000);
                }
            });
        } else {
            Swal.fire({
                title: '¿Desea guardar el movimiento?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Guardando...',
                        didOpen: () => {
                            Swal.showLoading();
                            form.submit();
                        },
                        allowOutsideClick: false,
                        showConfirmButton: false
                    });
                }
            });
        }
    });
});
</script>

{% endblock %}