{% extends 'main/base.html' %}
{% load crispy_forms_tags %}

{% block title %} Detalle del Cliente {% endblock title %}

{% block content %}

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm border-0">

            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0">Detalle del Cliente</h4>
            </div>

            <div class="card-body">

                <h4 class="text-center mb-4">{{ b.fantasy_name }}</h4>

                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-4">Información General</h5>
                        <ul class="list-group mb-4">
                            <li class="list-group-item"><strong>Razón social:</strong> {{ b.bussiness_name }}</li>
                            <li class="list-group-item"><strong>RUT:</strong> {{ b.rut }}</li>
                            <li class="list-group-item"><strong>Email de contacto:</strong> {{ b.email|default:"No registrado" }}</li>
                            <li class="list-group-item"><strong>Teléfono de contacto:</strong> {{ b.phone|default:"No registrado" }}</li>
                            <li class="list-group-item"><strong>Terminos de comercio:</strong>{{ b.trade_terms|default:"No registrado" }}</li>
                            <li class="list-group-item"><strong>Dirección:</strong> {{ b.address|default:"No registrado" }}</li>
                            <li class="list-group-item"><strong>Ciudad:</strong> {{ b.city|default:"No registrado" }}
                            </li>
                            <li class="list-group-item"><strong>País:</strong> {{ b.country|default:"No registrado" }}
                            </li>
                            <li class="list-group-item"><strong>Sitio web:</strong> {{ b.web_site|default:"No registrado" }}</li>
                            <li class="list-group-item"><strong>Plazo de pago:</strong>
                                {% if b.payments_terms_days %}
                                {% if b.payments_terms_days == 30 %}
                                <span>30 días</span>
                                {% elif b.payments_terms_days == 60 %}
                                <span>60 días</span>
                                {% elif b.payments_terms_days == 90 %}
                                <span>90 días</span>
                                {% else %}
                                <span>{{ b.payments_terms_days }} días</span>
                                {% endif %}
                                {% else %}
                                <span>No registrado</span>
                                {% endif %}
                            <li class="list-group-item"><strong>Plazo de entrega:</strong>
                                {% if b.lead_time_days %}
                                {% if b.lead_time_days == 30 %}
                                <span>30 días</span>
                                {% elif b.lead_time_days == 60 %}
                                <span>60 días</span>
                                {% elif b.lead_time_days == 90 %}
                                <span>90 días</span>
                                {% else %}
                                <span>{{ b.lead_time_days }} días</span>
                                {% endif %}
                                {% else %}
                                <span>No registrado</span>
                                {% endif %}
                            </li>
                            <li class="list-group-item"><strong>Moneda:</strong> {{ b.currency|default:"No registrado" }}</li>
                            <li class="list-group-item"><strong>Descuento:</strong> {{ b.discount_percentage|default:"No registrado" }}</li>
                            <li class="list-group-item"><strong>Preferido:</strong>
                                {% if b.is_preferred %}
                                <span class="badge bg-success">Sí</span>
                                {% else %}
                                <span class="badge bg-danger">No</span>
                                {% endif %}
                            </li>
                            <li class="list-group-item"><strong>Estado:</strong>
                                {% if b.is_active %}
                                <span class="badge bg-success">Activo</span>
                                {% else %}
                                <span class="badge bg-danger">Inactivo</span>
                                {% endif %}
                            </li>
                        </ul>
                    </div>

                    <div class="col-md-6">
                        <div class="row mb-2">
                            <div class="col-6">
                                <h5 class="">Bodegas Asociadas</h5>
                            </div>
                            <div class="col-6 text-end align-text-bottom align-top">
                                <button type="button" class="btn btn-danger align-text-bottom align-top"
                                    id="warehouse_assign_button">
                                    <i class="bi bi-plus"></i> Asignar
                                </button>
                            </div>
                        </div>

                        <div id="available_warehouses_container" class="mt-3" style="display: none;">
                        </div>

                        {% if warehouses %}
                        <div class="list-group">
                            {% for w in warehouses %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ w.name }}</strong><br>
                                    <small class="text-muted">{{ w.address }} - {{ w.location }} - {{w.wareclients.first.association_date }}</small>
                                    {% if w.wareclients.first.is_active == True %}
                                    <span class="badge bg-success">Activo</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Inactivo</span>
                                    {% endif %}
                                </div>

                                <a href="{% url 'warehouse_update' w.id %}?next={{ request.path }}&client={{ b.id }}"
                                    class="btn btn-sm btn-outline-primary me-2">
                                    Editar
                                </a>
                                <a href="{% url 'warehouse_unnasign' %}?next={{ request.path }}&client={{ b.id }}&warehouse={{ w.id }}"
                                    class="btn btn-sm btn-outline-danger">
                                    Desasignar
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-secondary text-center">
                            No hay bodegas asociadas.
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="{% url 'client_update' b.id %}" class="btn btn-primary me-2">Editar</a>
                    <a href="{% url 'client_list_all' %}" class="btn btn-secondary me-2">Volver</a>
                    <button type="button" class="btn btn-danger btn-delete" data-url="{% url 'client_delete' b.id %}"
                        data-item-name="{{ b.fantasy_name }}">
                        Eliminar
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

{% endblock content %}
{% block scripts %}
<script>
    const clientId = "{{ b.id }}"; 
    const assignButton = document.getElementById('warehouse_assign_button');
    const availableWarehousesContainer = document.getElementById('available_warehouses_container');
    let isVisible = false;
    let isLoaded = false; 
    assignButton.addEventListener('click', function () {
        isVisible = !isVisible;
        availableWarehousesContainer.style.display = isVisible ? 'block' : 'none';

        if (isVisible) {
            assignButton.innerHTML = '<i class="bi bi-x-lg"></i> Cerrar';
            assignButton.classList.remove('btn-danger');
            assignButton.classList.add('btn-secondary');
            if (!isLoaded) {
                availableWarehousesContainer.innerHTML = '<div class="alert alert-info text-center">Cargando bodegas disponibles...</div>';
                
                fetch("{% url 'warehouse_list_without_this_client' %}?client=" + clientId)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`La vista devolvió el código ${response.status}.`);
                        }
                        return response.json(); 
                    })
                    .then(data => {
                        let htmlContent = '';
                        
                        if (data.warehouses && data.warehouses.length > 0) {
                            htmlContent += '<h6 class="mt-3">Bodegas disponibles:</h6>';
                            htmlContent += '<table class="table table-sm table-striped"><thead><tr><th>Nombre</th><th>Ubicación</th><th class="text-center">Acción</th></tr></thead><tbody>';
                            
                            data.warehouses.forEach(warehouse => {
                                htmlContent += `
                                    <tr>
                                        <td><strong>${warehouse.name}</strong></td>
                                        <td>${warehouse.location}</td>
                                        <td class="text-center">
                                            <a href="{% url 'warehouse_assign' %}?client=${clientId}&warehouse=${warehouse.id}&next={{ request.path }}" class="btn btn-sm btn-outline-primary">
                                                Asignar
                                            </a>
                                        </td>
                                    </tr>
                                `;
                            });
                            htmlContent += '</tbody></table>';
                            
                            availableWarehousesContainer.innerHTML = htmlContent;
                            isLoaded = true;
                        } else {
                            availableWarehousesContainer.innerHTML = '<div class="alert alert-success text-center">No hay más bodegas disponibles para asignar.</div>';
                            isLoaded = true;
                        }
                        
                    })
                    .catch(error => {
                        console.error('Error al cargar bodegas:', error);
                        availableWarehousesContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                        assignButton.innerHTML = '<i class="bi bi-plus"></i> Asignar (Error)';
                        assignButton.classList.remove('btn-secondary');
                        assignButton.classList.add('btn-danger');
                        isVisible = false;
                    });
            }
        } else {
            assignButton.innerHTML = '<i class="bi bi-plus"></i> Asignar';
            assignButton.classList.remove('btn-secondary');
            assignButton.classList.add('btn-danger');
        }
    });
</script>
{% endblock %}
