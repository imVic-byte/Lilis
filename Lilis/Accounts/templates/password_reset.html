{% extends 'main/base.html' %}
{% load crispy_forms_tags %}

{% block title %} Recuperar Contraseña {% endblock title %}

{% block content %}
    <div class="row justify-content-center"> <div class="col-lg-6"> <section class="card" role="region" aria-label="Formulario de recuperación de contraseña">
                <div class="card-header text-center bg-primary text-white"> <h1 id="title" class="h4 mb-0">Recuperar contraseña</h1> </div>
                
                <div class="card-body p-4"> <p class="lead text-center">Introduce tu correo para recibir un enlace de recuperación.</p>

                    <form id="recovery-form" autocomplete="off">
                        
                        <div class="mb-3"> <label for="email" class="form-label">Correo electrónico</label>
                            <input id="email" name="email" type="email" inputmode="email" placeholder="tú@ejemplo.com" required
                                class="form-control" aria-describedby="email-help" /> <div id="email-help" class="form-text"> Te enviaremos un enlace para restablecer la contraseña.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="token" class="form-label">Token (opcional)</label>
                            <input id="token" name="token" type="text" placeholder="Código recibido por correo"
                                class="form-control" aria-describedby="token-help" />
                            <div id="token-help" class="form-text">
                                Si pegaste un token, podrás cambiar la contraseña directamente.
                            </div>
                        </div>

                        <hr aria-hidden="true" />

                        <div class="mb-3">
                            <label for="password" class="form-label">Nueva contraseña</label>
                            <div class="input-group"> <input id="password" name="password" type="password" placeholder="Mínimo 8 caracteres"
                                    class="form-control" aria-describedby="pw-help" required />
                                <button class="btn btn-outline-secondary" type="button" id="toggle-pw"
                                    aria-label="Mostrar contraseña">Mostrar</button>
                            </div>
                            <div id="pw-help" class="form-text">Usa al menos 8 caracteres, letras y números.</div>
                            <div class="progress mt-2" style="height: 8px;"> <div id="strength-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm" class="form-label">Confirmar contraseña</label>
                            <input id="confirm" name="confirm" type="password" placeholder="Repite la nueva contraseña"
                                class="form-control" required />
                        </div>

                        <div class="d-grid gap-2 mt-4"> <button type="submit" class="btn btn-primary btn-lg">Restablecer contraseña</button>
                            <button type="button" class="btn btn-secondary" id="send-link">Enviar solo el enlace</button>
                        </div>

                        <p class="text-muted small text-center" style="margin-top:12px">Revisa tu carpeta de spam si no ves el correo.</p>

                        <div id="response" style="margin-top:12px;display:none" role="status" aria-live="polite"></div>
                    </form>
                </div> </section>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    <script>
        // Referencias
        const form = document.getElementById('recovery-form');
        const email = document.getElementById('email');
        const token = document.getElementById('token');
        const pw = document.getElementById('password');
        const confirm = document.getElementById('confirm');
        const resp = document.getElementById('response');
        const sendLinkBtn = document.getElementById('send-link');
        const togglePw = document.getElementById('toggle-pw');
        const strengthBar = document.getElementById('strength-bar');

        // Mostrar / ocultar contraseña
        togglePw.addEventListener('click', () => {
            const t = pw.type === 'password' ? 'text' : 'password';
            pw.type = t; confirm.type = t;
            togglePw.textContent = t === 'text' ? 'Ocultar' : 'Mostrar';
        });

        // Indicador de fuerza simple
        function evaluateStrength(value) {
            let score = 0;
            if (value.length >= 8) score += 1;
            if (/[A-Z]/.test(value)) score += 1;
            if (/[0-9]/.test(value)) score += 1;
            if (/[^A-Za-z0-9]/.test(value)) score += 1;
            
            // Damos color al progress bar
            strengthBar.classList.remove('bg-danger', 'bg-warning', 'bg-success');
            if (score <= 1) strengthBar.classList.add('bg-danger');
            else if (score <= 2) strengthBar.classList.add('bg-warning');
            else strengthBar.classList.add('bg-success');

            return score; // 0..4
        }

        pw.addEventListener('input', () => {
            const s = evaluateStrength(pw.value);
            const percent = (s / 4) * 100;
            strengthBar.style.width = percent + '%';
        });

        // Función para mostrar mensajes
        function showMessage(text, isError = false) {
            resp.style.display = 'block';
            resp.className = isError ? 'alert alert-danger' : 'alert alert-success';
            resp.textContent = text;
        }

        // Enviar enlace (simulado)
        sendLinkBtn.addEventListener('click', async () => {
            if (!email.checkValidity()) {
                email.reportValidity();
                return;
            }
            showMessage('Enviando enlace...', false);

            setTimeout(() => {
                showMessage('Enlace enviado a ' + email.value + ', revisa tu correo.', false);
            }, 700);
        });

        // Envío del formulario para restablecer contraseña
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Validaciones básicas
            if (!email.checkValidity()) return email.reportValidity();
            if (pw.value.length < 8) {
                showMessage('La contraseña debe tener al menos 8 caracteres.', true); return;
            }
            if (pw.value !== confirm.value) {
                showMessage('Las contraseñas no coinciden.', true); return;
            }

            showMessage('Procesando...', false);

            // Simulación de petición al servidor
            setTimeout(() => {
                showMessage('Contraseña restablecida correctamente. Puedes iniciar sesión con tu nueva contraseña.', false);
                form.reset();
                strengthBar.style.width = '0%';
            }, 900);
        });

    </script>
{% endblock %}